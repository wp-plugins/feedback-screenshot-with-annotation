/* 
 * Feedback annotation <http://sulaeman.com>
 * Copyright (c) 2011 Sulaeman. All rights reserved.
 * http://www.twitter.com/sulaeman 
 */
 
function fi_fdbck_success(a){jQuery("#fi-fdbck-ifrm").remove();jQuery("#fi-fdbck-overlay").hide();jQuery("#fi-fdbck-loading").hide();jQuery("#fi-fdbck-status").text(a).fadeIn();jQuery("#fi-fdbck-annotator").remove();jQuery(".fi-fdbck-text").val("").hide();jQuery("#fi-fdbck-screen").val("");jQuery("#fi-fdbck-content").animate({bottom:"-=390"},500)}function fi_fdbck_error(a){jQuery("#fi-fdbck-ifrm").remove();jQuery("#fi-fdbck-overlay").hide();jQuery("#fi-fdbck-loading").hide();jQuery("#fi-fdbck-status").text(a).fadeIn()}(function($){$.fn.fiFeedback=function(options){this.settings={startIndex:1e5,domAnnotate:"h1, h2, h3, h4, h5, h6, a, p, input, textarea, span, label, legend, img"};var doc=$(document);var body=$("body");var obj=this;var canvas={};var dom={};var newObj={};var NewObjClose={};this.minimized=false;this.active=false;this.highLighting=true;this.class="fi-fdbck-highlight";this.iframeAnnotator={};this.iframeAnnotatorBody={};this.width=0;this.height=0;this.position={};this.availableAnnotate=[];this.annotated=[];if(options){$.extend(this.settings,options)}if(!$.browser.msie){$("#fi-fdbck-container").fadeIn()}$("#fi-fdbck-control").click(function(a){if(!obj.minimized){$("#fi-fdbck-status").text(GENERATING_STATUS).fadeIn();obj.width=doc.width();obj.height=doc.height()}if($(".fi-fdbck-text").is(":hidden")||obj.minimized){$("#fi-fdbck-content").animate({bottom:"+=390"},500,function(){if(!obj.minimized){obj.activateAnnotator();$("#fi-fdbck-screen-source").val("");$("#fi-fdbck-screen").val("");$(".fi-fdbck-text").fadeIn();$("#fi-fdbck-status").fadeOut(500,function(){$(this).text("")})}})}else{$("#fi-fdbck-content").animate({bottom:"-=390"},500,function(){obj.deactivateAnnotator();$(".fi-fdbck-text").hide()})}a.preventDefault()});$("#fi-fdbck-minimize-button").click(function(a){obj.minimized=true;$("#fi-fdbck-content").animate({bottom:"-=390"},500);a.preventDefault()});$("#fi-fdbck-hightlight-button").click(function(a){obj.setBackground(true);$("#fi-fdbck-blackout-button").removeClass("fi-fdbck-button-selected");$(this).addClass("fi-fdbck-button-selected");a.preventDefault()});$("#fi-fdbck-blackout-button").click(function(a){obj.setBackground(false);$("#fi-fdbck-hightlight-button").removeClass("fi-fdbck-button-selected");$(this).addClass("fi-fdbck-button-selected");a.preventDefault()});$("#fi-fdbck-button").click(function(a){$("#fi-fdbck-overlay").css({width:obj.width,height:obj.height}).show();$("#fi-fdbck-loading").fadeIn();new html2canvas(obj.get(0),{allowImageBaseUrl:BASE_URL,doNotRenderObjClasses:["fi-fdbck-ignore-render"],letterRendering:true,ready:function(a){$(a.canvas).hide().appendTo("body");$("#fi-fdbck-screen").val(a.canvas.toDataURL("image/jpeg"));$('<iframe id="fi-fdbck-ifrm" name="fi-fdbck-ifrm" src="" width="0" height="0" frameBorder="0" style="overflow: hidden; display: none;"></iframe>').appendTo("body");$("#fi-fdbck-frm").submit()}});a.preventDefault()});this.setBackground=function(a){obj.highLighting=a;if(obj.highLighting){this.class="fi-fdbck-highlight"}else{this.class="fi-fdbck-censor"}};this.activateAnnotator=function(){obj.createAnnotator();var coords={};$(obj.settings.domAnnotate,obj).each(function(index){dom=$(this);if(!dom.hasClass("fi-fdbck-ignore-annotate")){obj.settings.startIndex=obj.settings.startIndex+index;obj.position=dom.offset();newObj=$('<div id="fi_fdbck_annotate_'+index+'"/>').css({position:"absolute",top:obj.position.top-2,left:obj.position.left-2,zIndex:obj.settings.startIndex,width:dom.width()+4,height:dom.height()+4});newObj.click(function(){obj.selectAnnotate(this)});newObj.mouseover(function(){if(!$(this).hasClass("selected")){obj.highlightAnnotate(this)}});newObj.mouseout(function(){if(!$(this).hasClass("selected")){obj.removeHighlight(this)}});obj.settings.startIndex=obj.settings.startIndex+1;newObjClose=$('<div class="annotate-close fi-fdbck-annotate-close" />').css({top:obj.position.top-17,left:obj.position.left+dom.width()-10,zIndex:obj.settings.startIndex});obj.iframeAnnotator.append(newObj);obj.iframeAnnotator.append(newObjClose);coords=obj.getCoords(newObj.eq(0));obj.availableAnnotate=$.extend({},obj.availableAnnotate,eval("{fi_fdbck_annotate_"+index+": {}}"));obj.availableAnnotate["fi_fdbck_annotate_"+index]=coords}});delete coords};this.deactivateAnnotator=function(){obj.iframeAnnotator.remove()};this.highlightAnnotate=function(a){$(a).removeClass("fi-fdbck-highlight").removeClass("fi-fdbck-censor").addClass(obj.class+" fi-fdbck-annotate-current")};this.selectAnnotate=function(a){if(!obj.inArray(a.id,obj.annotated)){obj.annotated=$.merge(obj.annotated,[a.id])}obj.highlightAnnotate(a);$(a).addClass("selected").next().show();obj.assignBoxListners(a)};this.removeHighlight=function(a){$(a).removeClass("fi-fdbck-highlight").removeClass("fi-fdbck-censor").removeClass("fi-fdbck-annotate-current")};this.closeHighlight=function(a){var b=$(a.target);obj.annotated=jQuery.grep(obj.annotated,function(a){return a!=b.prev().attr("id")});if(b.is(".fi-fdbck-annotate-drag-close")){b.prev().remove();b.remove()}else{b.hide().prev().removeClass("fi-fdbck-highlight").removeClass("fi-fdbck-censor").removeClass("fi-fdbck-annotate-current").removeClass("selected").unbind("mouseenter",obj.showCloseButton).unbind("mouseleave",obj.hideCloseButton)}};this.createAnnotator=function(){obj.iframeAnnotator=$('<div id="fi-fdbck-annotator" />').css({position:"absolute",display:"block",left:0,top:0,width:obj.width,height:obj.height,zIndex:1e5}).appendTo("body");obj.active=true;obj.iframeAnnotator.mousedown(obj.dragStart)};this.dragStart=function(a){if(!obj.active){return}if(a.which!=1){return}if($(a.target).hasClass("fi-fdbck-annotate-current")||$(a.target).prev().hasClass("fi-fdbck-annotate-current")){return}if(obj.highLighting){$(".fi-fdbck-annotate-drag-current",obj.iframeAnnotator).remove();obj.iframeAnnotator.prepend('<div class="fi-fdbck-highlight fi-fdbck-annotate-drag-current" />')}else{obj.iframeAnnotator.prepend('<div class="fi-fdbck-censor fi-fdbck-annotate-drag-current" />')}obj.settings.startIndex=obj.settings.startIndex+1;$(".fi-fdbck-annotate-drag-current",obj.iframeAnnotator).css({top:a.pageY,left:a.pageX,opacity:.5,zIndex:obj.settings.startIndex});$(".fi-fdbck-annotate-drag-current",obj.iframeAnnotator).get(0).x=a.pageX;$(".fi-fdbck-annotate-drag-current",obj.iframeAnnotator).get(0).y=a.pageY;obj.iframeAnnotator.mousemove(obj.drag);obj.iframeAnnotator.mouseup(obj.dragEnd)};this.drag=function(a){var b=a.pageX-$(".fi-fdbck-annotate-drag-current",obj.iframeAnnotator).get(0).x;var c=a.pageY-$(".fi-fdbck-annotate-drag-current",obj.iframeAnnotator).get(0).y;if(b<0){b=b*-1;$(".fi-fdbck-annotate-drag-current",obj.iframeAnnotator).css({left:a.pageX})}if(c<0){c=c*-1;$(".fi-fdbck-annotate-drag-current",obj.iframeAnnotator).css({top:a.pageY})}$(".fi-fdbck-annotate-drag-current",obj.iframeAnnotator).css({width:b,height:c})};this.dragEnd=function(a){var b=$(".fi-fdbck-annotate-drag-current",obj.iframeAnnotator);var c=b.offset();if(b.height()*b.width()<20){b.remove()}obj.iframeAnnotator.unbind("mousedown",obj.dragStart);obj.iframeAnnotator.unbind("mousemove",obj.drag);obj.iframeAnnotator.unbind("mouseup",obj.dragEnd);if(obj.highLighting){b.css("background","none")}b.css("opacity",1);obj.iframeAnnotator.mousedown(obj.dragStart);b.removeClass("fi-fdbck-annotate-drag-current").addClass("fi-fdbck-annotate-current");obj.settings.startIndex=obj.settings.startIndex+1;$('<div class="annotate-close fi-fdbck-annotate-drag-close" />').css({top:c.top-17,left:c.left+b.width()-10,zIndex:obj.settings.startIndex}).insertAfter(b);obj.assignBoxListners(b.eq(0));delete b;delete c};this.getCoords=function(a){var b=$(a,obj.iframeAnnotator).position();return{top:b.top,left:b.left,bottom:b.top+$(a,obj.iframeAnnotator).height(),right:b.left+$(a,obj.iframeAnnotator).width()}};this.assignBoxListners=function(a){$(a).mouseenter(obj.showCloseButton).mouseleave(obj.hideCloseButton);$(a).next().click(obj.closeHighlight).mouseleave(obj.hideCloseButton)};this.showCloseButton=function(a){jQuery(a.target).next().show()};this.hideCloseButton=function(a){if(!jQuery(a.relatedTarget).is(".fi-fdbck-annotate-close, .fi-fdbck-annotate-drag-close")){if(jQuery(a.target).is(".fi-fdbck-annotate-close, .fi-fdbck-annotate-drag-close")){jQuery(a.target).hide()}else{jQuery(a.target).next().hide()}}};this.inArray=function(a,b,c){var d="",e=!!c;if(e){for(d in b){if(b[d]===a){return true}}}else{for(d in b){if(b[d]==a){return true}}}return false};this.base64Encode=function(a){var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var c,d,e,f,g,h,i,j,k=0,l=0,m="",n=[];if(!a){return a}a=MySellr.utf8Encode(a+"");do{c=a.charCodeAt(k++);d=a.charCodeAt(k++);e=a.charCodeAt(k++);j=c<<16|d<<8|e;f=j>>18&63;g=j>>12&63;h=j>>6&63;i=j&63;n[l++]=b.charAt(f)+b.charAt(g)+b.charAt(h)+b.charAt(i)}while(k<a.length);m=n.join("");switch(a.length%3){case 1:m=m.slice(0,-2)+"==";break;case 2:m=m.slice(0,-1)+"=";break}return m};this.utf8Encode=function(a){if(a===null||typeof a==="undefined"){return""}var b=a+"";var c="",d,e,f=0;d=e=0;f=b.length;for(var g=0;g<f;g++){var h=b.charCodeAt(g);var i=null;if(h<128){e++}else if(h>127&&h<2048){i=String.fromCharCode(h>>6|192)+String.fromCharCode(h&63|128)}else{i=String.fromCharCode(h>>12|224)+String.fromCharCode(h>>6&63|128)+String.fromCharCode(h&63|128)}if(i!==null){if(e>d){c+=b.slice(d,e)}c+=i;d=e=g+1}}if(e>d){c+=b.slice(d,f)}return c}}})(jQuery);